<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cross‑Wind Challenge</title>
  <style>
    :root { --bg:#0e1116; --ink:#e7e9ef; --muted:#a5adbd; --accent:#8ef5b1; --line:#1e2536; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{background:var(--bg);color:var(--ink);font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{display:grid;grid-template-rows:min-content 1fr min-content;height:100%}
    .hud{display:grid;grid-auto-flow:column;gap:10px;padding:12px;justify-content:start}
    .pill{background:#0f1422;border:1px solid var(--line);border-radius:12px;padding:10px 12px;color:var(--ink)}
    .pill strong{font-weight:700}
    .stage{position:relative;width:100%;height:calc(100vh - 170px);min-height:520px}
    canvas{position:absolute;inset:0;width:100%;height:100%;display:block}
    .footer{display:grid;grid-template-columns:1fr auto auto;gap:12px;padding:12px;align-items:center}
    .btn{cursor:pointer;background:#0c1520;border:1px solid var(--line);color:var(--ink);padding:12px 14px;border-radius:14px;font-weight:700}
    .btn.primary{background:#0f1c16;border-color:#214636;color:var(--accent)}
    .btn.warn{background:#1d1414;border-color:#3b2323;color:#ff8a8a}
    @media (max-width:900px){.stage{height:calc(100vh - 220px)}.hud{grid-auto-flow:row;grid-template-columns:repeat(2,minmax(0,1fr))}.footer{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hud">
      <div class="pill">💨 <strong>Wind:</strong> <span id="wind">—</span> mph FROM <span id="from">—</span>°</div>
      <div class="pill">📏 <strong>Range:</strong> <span id="range">—</span> yds</div>
      <div class="pill">⬇️ <strong>Try DOPE:</strong> <span id="tryV">—</span> UP</div>
      <div class="pill">📈 <strong>Avg:</strong> <span id="avg">0.0</span> <span id="unitsAvg">MIL</span> (<span id="shotIdx">0</span>/10)</div>
      <div class="pill">🎯 <strong>Score:</strong> <span id="score">0</span> • High: <span id="high">0</span></div>
      <div class="pill">⚙️ <strong><span id="unitsLabel">MIL</span></strong> • <span id="modeLabel">Centerfire</span></div>
    </div>

    <div class="stage"><canvas id="scope"></canvas></div>

    <div class="footer">
      <div style="font-weight:800">Round <span id="round">0</span>/10</div>
      <div style="display:flex;gap:10px">
        <button id="hint" class="btn">💡 Hint (−50%)</button>
        <button id="reveal" class="btn primary">👁️ Reveal</button>
      </div>
      <div style="display:flex;gap:10px">
        <button id="toggleUnits" class="btn">Toggle MIL/MOA</button>
        <button id="toggleMode" class="btn">Centerfire/Rimfire</button>
        <button id="newRound" class="btn warn">New Session</button>
      </div>
    </div>
  </div>

  <script>
  (()=>{
    const C={
      // === constants mirror Dart ===
      MAX_H_MIL:6.0, MAX_V_MIL:12.0,
      RANGE:[100,200,300,400,500,600,700,800,900,1000],
      DOPE_MIL:[0.0,0.5,1.1,1.9,3.0,4.2,5.6,7.1,8.8,10.6],
      IPSC_W_IN:18.0, IPSC_H_IN:30.0, A_W_IN:6.0, A_H_IN:11.0, A_TOP_IN:4.0, D_MARGIN_IN:3.0,
      MOA_PER_MIL:3.43774677,
      JITTER_PAD_MIL:0.12
    };

    // === state ===
    let units='MIL'; // 'MIL'|'MOA'
    let mode='CF';   // 'CF'|'RF'
    const S={
      round:0, sessionScore:0, highScore:0, revealed:false, hintUsed:false,
      avgAbsHold:0, holdsCount:0,
      // truth
      rangeYds:200, windMph:10, windFrom:120, mphGun:6.0, trueElev:0, trueWind:0,
      // player
      guessH:0, guessV:0,
      // vis mapping
      pxX:10, pxY:10, upxX:0.1, upxY:0.1, drag:null, hintBand:null
    };

    const $=id=>document.getElementById(id);
    const HUD={ wind:$('wind'), from:$('from'), range:$('range'), tryV:$('tryV'), avg:$('avg'), unitsAvg:$('unitsAvg'), shotIdx:$('shotIdx'), score:$('score'), high:$('high'), unitsLabel:$('unitsLabel'), modeLabel:$('modeLabel'), round:$('round') };
    const BTN={ hint:$('hint'), reveal:$('reveal'), toggleUnits:$('toggleUnits'), toggleMode:$('toggleMode'), newRound:$('newRound') };
    const canvas=document.getElementById('scope'); const ctx=canvas.getContext('2d',{alpha:true});

    // === math helpers ===
    const toMOA=mil=>mil*C.MOA_PER_MIL; const toMIL=moa=>moa/C.MOA_PER_MIL; const snap1=v=>Math.round(v*10)/10; const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));

    // === functions ported 1:1 from Dart ===
    function _computeWindHoldMil(rangeYds, windMph, fromDeg){
      const mphGun=(S.mphGun!=null && S.mphGun>0)?S.mphGun:6.0;
      const rangeKyd=rangeYds/1000.0;
      const s=Math.abs(Math.sin((fromDeg%360)*Math.PI/180));
      const sign=((fromDeg%360)<180.0)?1.0:-1.0; // 0..179 → push right (+)
      let mil=(windMph/mphGun)*rangeKyd*s*sign;
      // optional spin drift (disabled by default; can expose toggle)
      // if(includeSpin) mil += 0.00007*Math.pow(rangeYds,1.2)*1.0;
      return mil;
    }

    function _tryDopeMil(rangeYds){
      const X=C.RANGE, Y=C.DOPE_MIL; if(rangeYds<=X[0])return Y[0]; if(rangeYds>=X[X.length-1])return Y[Y.length-1];
      for(let i=0;i<X.length-1;i++){const x0=X[i],x1=X[i+1]; if(rangeYds>=x0 && rangeYds<=x1){const y0=Y[i],y1=Y[i+1]; const t=(rangeYds-x0)/(x1-x0); return y0+t*(y1-y0);} }
      return Y[Y.length-1];
    }

    function _inchesToMilAtRange(inches, rangeYds){ return inches/(36.0*(rangeYds/1000.0)); }

    function _scoreZoneForImpact(dxMil, dyMil, rangeYds){
      const pad=C.JITTER_PAD_MIL;
      const halfW=_inchesToMilAtRange(C.IPSC_W_IN/2.0,rangeYds)+pad;
      const halfH=_inchesToMilAtRange(C.IPSC_H_IN/2.0,rangeYds)+pad;
      const torsoTopOffsetMil=_inchesToMilAtRange(C.IPSC_W_IN*0.40,rangeYds);
      const torsoCenterYMil=torsoTopOffsetMil - halfH + pad;
      const lx=dxMil; const ly=dyMil - torsoCenterYMil;
      const inTorso=(Math.abs(lx)<=halfW)&&(Math.abs(ly)<=halfH); if(!inTorso) return 'Miss';
      const aHalfW=_inchesToMilAtRange(C.A_W_IN/2.0,rangeYds)+pad*0.6;
      const aHalfH=_inchesToMilAtRange(C.A_H_IN/2.0,rangeYds)+pad*0.6;
      const aTopFromTorsoTopMil=_inchesToMilAtRange(C.A_TOP_IN,rangeYds);
      const aCenterYMil=(halfH - pad - aTopFromTorsoTopMil - aHalfH);
      if (Math.abs(lx)<=aHalfW && Math.abs(ly - aCenterYMil)<=aHalfH) return 'A';
      const dInset=_inchesToMilAtRange(C.D_MARGIN_IN,rangeYds) - pad*0.5;
      const nearEdge = (lx < -halfW + dInset) || (lx > halfW - dInset) || (ly > halfH - dInset) || (ly < -halfH + dInset);
      if (nearEdge) return 'D';
      return 'C';
    }

    function _autoRimfireMphFromVelocity(fps){
      const T=[[900,1.0],[980,1.2],[1040,1.4],[1100,1.7],[1200,2.1],[1300,2.5],[1500,3.0]];
      if(fps<=T[0][0])return T[0][1]; if(fps>=T[T.length-1][0])return T[T.length-1][1];
      for(let i=0;i<T.length-1;i++){const [x0,y0]=T[i],[x1,y1]=T[i+1]; if(fps>=x0 && fps<=x1){const t=(fps-x0)/(x1-x0); return Math.round((y0+t*(y1-y0))*100)/100;}}
      return null;
    }

    function _resolveMphGunForGame({isRimfire, velocityFps, bcG1, geMph}){
      if(geMph!=null && geMph>0) return geMph;
      if(isRimfire && velocityFps!=null){ const m=_autoRimfireMphFromVelocity(velocityFps); if(m!=null && m>0) return m; }
      if(!isRimfire && bcG1!=null && bcG1>0){ return Math.max(3.0, Math.min(10.0, bcG1*10.0)); }
      return 6.0;
    }

    // === game flow ===
    function _pickDistanceYds(isRF){ const min=isRF?100:100, max=isRF?400:1000; const steps=Math.floor((max-min)/50); return min + Math.floor(Math.random()*(steps+1))*50; }

    function _newRound(){
      S.round = (S.round%10)+1; S.revealed=false; S.hintUsed=false; S.hintBand=null;
      const isRF=(mode==='RF');
      S.rangeYds=_pickDistanceYds(isRF);
      S.windMph = 2 + Math.floor(Math.random()*19);
      const bands=[[60,120],[240,300],[0,360]]; const b=(Math.random()<0.7)?bands[Math.floor(Math.random()*2)]:bands[2];
      S.windFrom = Math.random()*(b[1]-b[0]) + b[0];
      S.mphGun = _resolveMphGunForGame({isRimfire:isRF, velocityFps:isRF?1080:null, bcG1:null, geMph:null});

      const elevMil=_tryDopeMil(S.rangeYds); S.trueElev = (units==='MIL')?elevMil:toMOA(elevMil);
      const trueWindMil=_computeWindHoldMil(S.rangeYds, S.windMph, S.windFrom); S.trueWind=(units==='MIL')?trueWindMil:toMOA(trueWindMil);
      S.guessH=0.0; S.guessV=S.trueElev;
      _updateHUD(); _draw();
    }

    function _reveal(){ if(S.revealed) return; S.revealed=true; const hMil=(units==='MIL')?S.guessH:toMIL(S.guessH); const vMil=(units==='MIL')?S.guessV:toMIL(S.guessV); const tH=(units==='MIL')?S.trueWind:toMIL(S.trueWind); const tV=(units==='MIL')?S.trueElev:toMIL(S.trueElev); const dx=hMil-tH, dy=vMil-tV; const zone=_scoreZoneForImpact(dx,dy,S.rangeYds); let pts=(zone==='A'?100:zone==='C'?70:zone==='D'?40:0); if(S.hintUsed) pts=Math.floor(pts*0.5); S.sessionScore+=pts; S.highScore=Math.max(S.highScore,S.sessionScore); S.avgAbsHold+=Math.abs(hMil); S.holdsCount++; _updateHUD(); _draw(); }

    function _hint(){ if(S.revealed) return; S.hintUsed=true; const halfMil=0.2; const half=(units==='MIL')?halfMil:toMOA(halfMil); const center=S.trueWind; S.hintBand={min:center-half,max:center+half}; _draw(); }

    function _next(){ if(!S.revealed) _reveal(); S.revealed=false; S.hintUsed=false; S.hintBand=null; _newRound(); }

    // === mapping & pointer ===
    function _map(){ const w=canvas.clientWidth, h=canvas.clientHeight; const maxHX=(units==='MIL')?C.MAX_H_MIL:toMOA(C.MAX_H_MIL); const maxVY=(units==='MIL')?C.MAX_V_MIL:toMOA(C.MAX_V_MIL); const pxW=(w-40)/(maxHX*2); const pxH=(h-160)/(maxVY+2); S.pxX=pxW; S.pxY=pxH; S.upxX=1/pxW; S.upxY=1/pxH; return {cx:w/2, cy:h*0.46, r:Math.min(w*0.9,h*0.8)/2}; }
    function _down(e){ const r=canvas.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left; const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top; S.drag={x,y,h:S.guessH,v:S.guessV}; }
    function _move(e){ if(!S.drag) return; const r=canvas.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left; const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top; const dx=(x-S.drag.x)*S.upxX; const dy=(y-S.drag.y)*S.upxY; const maxHX=(units==='MIL')?C.MAX_H_MIL:toMOA(C.MAX_H_MIL); const maxVY=(units==='MIL')?C.MAX_V_MIL:toMOA(C.MAX_V_MIL); S.guessH=clamp(snap1(S.drag.h+dx),-maxHX,maxHX); S.guessV=clamp(snap1(S.drag.v+dy),0,maxVY); HUD.tryV.textContent=snap1(S.guessV).toFixed(1)+' '+units; _draw(); }
    function _up(){ S.drag=null; }

    canvas.addEventListener('mousedown',_down); canvas.addEventListener('mousemove',_move); window.addEventListener('mouseup',_up);
    canvas.addEventListener('touchstart',_down,{passive:true}); canvas.addEventListener('touchmove',_move,{passive:true}); canvas.addEventListener('touchend',_up,{passive:true});

    // === drawing ===
    function _stroke(x1,y1,x2,y2,w=1,c='#ffffff55'){ ctx.strokeStyle=c; ctx.lineWidth=w; ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke(); }
    function _text(t,x,y,align='center'){ ctx.save(); ctx.fillStyle='#a5adbd'; ctx.textAlign=align; ctx.textBaseline='middle'; ctx.font='12px ui-monospace, monospace'; ctx.fillText(t,x,y); ctx.restore(); }
    function _dot(x,y,r,c){ ctx.fillStyle=c; ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill(); }

    function _draw(){ const w=canvas.clientWidth, h=canvas.clientHeight; ctx.clearRect(0,0,w,h); const {cx,cy,r}=_map();
      // bezel
      ctx.strokeStyle='#202635'; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.stroke();
      for(let a=0;a<360;a+=10){ const rad=a*Math.PI/180; const r1=r-10, r2=r-4; const major=(a%30===0); _stroke(cx+Math.cos(rad)*r1,cy+Math.sin(rad)*r1,cx+Math.cos(rad)*r2,cy+Math.sin(rad)*r2,major?1.5:1,major?'#ffffff66':'#ffffff33'); }
      [[0,'0'],[30,'HALF'],[60,'60'],[90,'90'],[120,'120'],[150,'HALF'],[180,'180'],[210,'HALF'],[240,'240'],[270,'270'],[300,'300'],[330,'HALF']].forEach(([a,t])=>{ const rad=(a-90)*Math.PI/180; _text(t,cx+Math.cos(rad)*(r-24),cy+Math.sin(rad)*(r-24)); });
      _text('MIL', cx - r + 22, cy);
      // clip scope interior
      ctx.save(); ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.clip(); ctx.fillStyle='#0b0e15'; ctx.fillRect(0,0,w,h);
      // grid
      const isMOA=(units==='MOA'); const maxHX=(units==='MIL')?C.MAX_H_MIL:toMOA(C.MAX_H_MIL); const maxVY=(units==='MIL')?C.MAX_V_MIL:toMOA(C.MAX_V_MIL);
      _stroke(cx - maxHX*S.pxX, cy, cx + maxHX*S.pxX, cy, 1.2, '#ffffff55');
      _stroke(cx, cy, cx, cy + maxVY*S.pxY, 1.2, '#ffffff55');
      const step=isMOA?1:0.5; for(let u=step; u<=maxHX; u+=step){ const major=isMOA ? (Math.abs(u%10)<1e-6) : (Math.abs(u%1)<1e-6); const len=major?16:(isMOA && Math.abs(u%5)<1e-6?12:8); _stroke(cx+u*S.pxX, cy-len/2, cx+u*S.pxX, cy+len/2, major?1.2:.9, '#ffffff77'); _stroke(cx-u*S.pxX, cy-len/2, cx-u*S.pxX, cy+len/2, major?1.2:.9, '#ffffff77'); if(major){ _text((isMOA?u:Math.round(u)).toString(), cx+u*S.pxX, cy-12); _text((isMOA?u:Math.round(u)).toString(), cx-u*S.pxX, cy-12);} }
      const rowStep=isMOA?2:1; const chevEvery=isMOA?10:2; for(let v=rowStep; v<=maxVY; v+=rowStep){ _stroke(cx - maxHX*S.pxX, cy + v*S.pxY, cx + maxHX*S.pxX, cy + v*S.pxY, 1, '#ffffff40'); if((v%chevEvery)===0){ ctx.save(); ctx.strokeStyle='#ffffffaa'; ctx.lineWidth=1.4; ctx.beginPath(); ctx.moveTo(cx-10, cy+v*S.pxY+10); ctx.lineTo(cx, cy+v*S.pxY); ctx.lineTo(cx+10, cy+v*S.pxY+10); ctx.stroke(); ctx.restore(); _text(String(v), cx - maxHX*S.pxX + 12, cy + v*S.pxY - 10, 'left'); } }
      // silhouette
      const halfW=_inchesToMilAtRange(C.IPSC_W_IN/2.0,S.rangeYds)*S.pxX; const halfH=_inchesToMilAtRange(C.IPSC_H_IN/2.0,S.rangeYds)*S.pxY; const topOff=_inchesToMilAtRange(C.IPSC_W_IN*0.40,S.rangeYds)*S.pxY; const torsoCy=cy + (topOff - halfH) + C.JITTER_PAD_MIL*S.pxY; ctx.fillStyle='#6b72801a'; ctx.strokeStyle='#ffffff22'; ctx.fillRect(cx-halfW, torsoCy-halfH, halfW*2, halfH*2); ctx.strokeRect(cx-halfW, torsoCy-halfH, halfW*2, halfH*2); const aHalfW=_inchesToMilAtRange(C.A_W_IN/2.0,S.rangeYds)*S.pxX + C.JITTER_PAD_MIL*0.6*S.pxX; const aHalfH=_inchesToMilAtRange(C.A_H_IN/2.0,S.rangeYds)*S.pxY + C.JITTER_PAD_MIL*0.6*S.pxY; const aTop=torsoCy - halfH + _inchesToMilAtRange(C.A_TOP_IN,S.rangeYds)*S.pxY; const aCy=aTop + aHalfH; ctx.strokeStyle='#ffffff44'; ctx.strokeRect(cx-aHalfW, aCy-aHalfH, aHalfW*2, aHalfH*2);
      // wind arrow
      const a=(S.windFrom-90)*Math.PI/180; const inner=r*0.65, outer=r*0.92; const x1=cx+Math.cos(a)*inner, y1=cy+Math.sin(a)*inner, x2=cx+Math.cos(a)*outer, y2=cy+Math.sin(a)*outer; _stroke(x1,y1,x2,y2,2,'#8ef5b1'); _text('FROM', x2+Math.cos(a)*18, y2+Math.sin(a)*18);
      // markers
      if(S.revealed){ _dot(cx + S.trueWind*S.pxX, cy + S.trueElev*S.pxY, 4, '#4cd137'); _dot(cx + S.guessH*S.pxX, cy + S.guessV*S.pxY, 4, '#ffcc00'); } else { _dot(cx + S.guessH*S.pxX, cy + S.guessV*S.pxY, 4, '#8ef5b1'); if(S.hintBand){ const x1=cx + S.hintBand.min*S.pxX, x2=cx + S.hintBand.max*S.pxX; ctx.fillStyle='#8ef5b133'; ctx.fillRect(Math.min(x1,x2), cy-r, Math.abs(x2-x1), r*2); }}
      ctx.restore();
      // ladder rows below
      _ladder(cx, cy + r + 26, w*0.86);
    }

    function _ladder(cx, topY, width){ const isMOA=(units==='MOA'); const rowStep=isMOA?2:1; const maxVY=(units==='MIL')?C.MAX_V_MIL:toMOA(C.MAX_V_MIL); const left=cx-width/2, right=cx+width/2; let y=topY; for(let v=2; v<=Math.min(12,maxVY); v+=rowStep){ _stroke(left,y,right,y,1,'#ffffff35'); const minorStep=isMOA?1:0.5; for(let i=1;i<Math.floor((right-left)/(S.pxX*minorStep));i++){ const x=left + i*S.pxX*minorStep; _stroke(x,y-4,x,y+4,1,'#ffffff35'); } _text(String(v), left-12, y, 'right'); y+=24; } }

    // === HUD ===
    function _updateHUD(){ HUD.wind.textContent=S.windMph.toFixed(0); HUD.from.textContent=S.windFrom.toFixed(0); HUD.range.textContent=S.rangeYds.toFixed(0); HUD.tryV.textContent=snap1(S.guessV).toFixed(1)+' '+units; HUD.avg.textContent=(S.holdsCount?(S.avgAbsHold/S.holdsCount):0).toFixed(1); HUD.unitsAvg.textContent=units; HUD.shotIdx.textContent=S.round.toString(); HUD.score.textContent=S.sessionScore.toString(); HUD.high.textContent=S.highScore.toString(); HUD.unitsLabel.textContent=units; HUD.modeLabel.textContent=(mode==='CF'?'Centerfire':'Rimfire'); HUD.round.textContent=S.round.toString(); }

    // === UI ===
    BTN.reveal.onclick=_reveal; BTN.hint.onclick=_hint; BTN.toggleUnits.onclick=()=>{ const conv=(units==='MIL')?toMOA:toMIL; S.guessH=conv(S.guessH); S.guessV=conv(S.guessV); S.trueWind=conv(S.trueWind); S.trueElev=conv(S.trueElev); units=(units==='MIL')?'MOA':'MIL'; _updateHUD(); _draw();}; BTN.toggleMode.onclick=()=>{ mode=(mode==='CF')?'RF':'CF'; _next();}; BTN.newRound.onclick=()=>{ S.round=0; S.sessionScore=0; S.avgAbsHold=0; S.holdsCount=0; _newRound(); };
    window.addEventListener('keydown',e=>{ if(e.code==='Space'){ e.preventDefault(); if(!S.revealed) _reveal(); else _next(); } });

    function _resize(){ const r=canvas.getBoundingClientRect(); canvas.width=Math.floor(r.width*(window.devicePixelRatio||1)); canvas.height=Math.floor(r.height*(window.devicePixelRatio||1)); ctx.setTransform(window.devicePixelRatio||1,0,0,window.devicePixelRatio||1,0,0); _draw(); }

    _resize(); _newRound(); window.addEventListener('resize',_resize);
  })();
  </script>
</body>
</html>
