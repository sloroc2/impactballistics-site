<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Wind Hold Challenge • Impact Ballistics</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="styles.css?v=11">
<meta name="description" content="Wind hold trainer like the app: drag the wind reticle, enter your hold, check, next. Minimal surface, fast flow.">
<style>
/* Page look to match your app vibe */
.page { display:grid; grid-template-columns: 1.1fr .9fr; gap:16px; }
.panel { background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(0,0,0,.02)); border:1px solid var(--line); border-radius:18px; padding:18px; }
.panel h2 { margin:0 0 10px; font-size:20px }
.readout { display:flex; flex-wrap:wrap; gap:10px; margin:8px 0 12px; }
.pill { border:1px solid var(--line); border-radius:999px; padding:6px 10px; }

.target {
  position:relative; height:360px; border:1px solid var(--line); border-radius:16px; background:#0f130f; overflow:hidden;
  touch-action:none; user-select:none;
}
.rings, .reticle, .windline { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); }
.rings::before, .rings::after {
  content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
  border-radius:50%; border:1px dashed var(--line);
}
.rings::before { width:260px; height:260px; }
.rings::after  { width:160px; height:160px; }
.dot { position:absolute; left:50%; top:50%; width:6px; height:6px; border-radius:50%; background:var(--brand); transform:translate(-50%,-50%); }

.windline {
  --deg: 0; --len: 80px;
  width: calc(var(--len) + 20px); height:2px; background:var(--brand);
  transform-origin: 10px 50%;
}
.windline::after{
  content:""; position:absolute; right:0; top:-5px; border:6px solid transparent; border-left-color:var(--brand);
}

.reticle {
  width: 56px; height: 56px; border-radius:50%;
  border:2px solid rgba(255,255,255,.18);
  box-shadow: inset 0 0 0 2px rgba(255,255,255,.06);
}
.cross {
  position:absolute; left:50%; top:50%; width:100%; height:100%; transform:translate(-50%,-50%);
}
.cross::before, .cross::after {
  content:""; position:absolute; background:rgba(255,255,255,.12);
}
.cross::before { left:50%; top:0; width:2px; height:100%; transform:translateX(-50%); }
.cross::after  { top:50%; left:0; width:100%; height:2px; transform:translateY(-50%); }

.hud { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
.big { font-size:28px; font-weight:800; letter-spacing:.3px }
.input, button { background:#111612; color:var(--ink); border:1px solid var(--line); border-radius:12px; padding:10px 12px; }
.actions { display:flex; flex-wrap:wrap; gap:10px; }

button.primary { background:linear-gradient(145deg,var(--brand),var(--brand-2)); color:#0b0f0b; border:0; font-weight:800; }
button.ghost { background:transparent; border:1px solid var(--line); }

.scorebox { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
.score { font-weight:800; } .good{color:#7EE887} .bad{color:#E87777}
.small { font-size:13px; color:var(--muted); }

.kbd { background:#0f130f; border:1px solid var(--line); border-radius:6px; padding:2px 6px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size:12px; }

/* Hidden settings drawer (press S) */
.drawer { display:none; margin-top:10px; padding:12px; border:1px solid var(--line); border-radius:12px; background:rgba(255,255,255,.02); }
.drawer .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
select{ background:#111612; color:var(--ink); border:1px solid var(--line); border-radius:10px; padding:8px 10px; }
.input.sm{ padding:8px 10px; width:120px }

@media (max-width: 900px){
  .page { grid-template-columns:1fr; }
  .target { height:320px; }
}
</style>
</head>
<body>
<header id="site-header" class="container nav"></header>
<script src="header.js?v=5"></script>

<main class="container">
  <section class="hero">
    <div class="kicker">Trainer</div>
    <h1 class="h1">Wind Hold Challenge</h1>
    <p class="sub">Drag the wind reticle like in the app. Enter your hold, check, next. Fast reps. Minimal knobs.</p>
  </section>

  <div class="page">
    <!-- Left: Target + HUD -->
    <div class="panel">
      <h2>Target</h2>
      <div class="target" id="target" aria-label="Wind trainer target">
        <div class="rings"></div>
        <div class="dot"></div>
        <div class="reticle">
          <div class="cross"></div>
        </div>
        <div class="windline" id="windline"></div>
      </div>

      <div class="hud">
        <span class="pill">Profile: <strong id="rProfile">CF</strong></span>
        <span class="pill">Range: <strong id="rRange">600</strong> yd</span>
        <span class="pill">Wind: <strong id="rWind">10.0</strong> mph</span>
        <span class="pill">Angle: <strong id="rAngle">90</strong>°</span>
        <span class="pill">Dir: <strong id="rDir">R</strong></span>
        <span class="pill">Mode: <strong id="rMode">GE</strong></span>
        <span class="pill">Units: <strong id="rUnits">MIL</strong></span>
      </div>

      <div class="row" style="margin-top:8px">
        <label for="answer" class="small" style="min-width:120px">Your hold (<span id="ansUnits">MIL</span>)</label>
        <input class="input big" type="number" id="answer" step="0.1" placeholder="e.g., 1.2">
        <button id="check" class="primary">Check</button>
        <button id="next" class="ghost">Next</button>
        <button id="show" class="ghost">Show</button>
      </div>

      <div class="scorebox" style="margin-top:10px">
        <div>Result: <span id="result" class="score">—</span></div>
        <div>| Session: <span id="sessGood" class="good">0</span> ✓ / <span id="sessBad" class="bad">0</span> ✗</div>
        <div>| Lifetime: <span id="lifeGood" class="good">0</span> ✓ / <span id="lifeBad" class="bad">0</span> ✗</div>
        <div class="small">Tol: ± <span id="tol">0.2</span> <span id="tolUnits">MIL</span></div>
      </div>

      <p class="small" style="margin-top:8px">
        Keys: <span class="kbd">N</span> new • <span class="kbd">Enter</span> check • <span class="kbd">S</span> settings • <span class="kbd">↑/↓</span> range • <span class="kbd">←/→</span> wind
      </p>

      <!-- Hidden Settings Drawer -->
      <div class="drawer" id="drawer">
        <div class="row" style="margin-bottom:8px">
          <label class="small">Mode</label>
          <select id="mode">
            <option value="GE">GE (mph-gun)</option>
            <option value="BC">Factory BC</option>
          </select>

          <label class="small">Units</label>
          <select id="units">
            <option value="MIL">MIL</option>
            <option value="MOA">MOA</option>
          </select>

          <label class="small">Profile</label>
          <select id="profile">
            <option value="CF">Centerfire</option>
            <option value="RF">Rimfire</option>
          </select>
        </div>

        <div class="row">
          <div>
            <label class="small">GE mph-gun</label>
            <input class="input sm" type="number" id="mphGun" min="1" step="0.1" placeholder="6">
          </div>
          <div>
            <label class="small">BC (G1)</label>
            <input class="input sm" type="number" id="bc" step="0.001" placeholder="0.510">
          </div>
          <div>
            <label class="small">MV (fps)</label>
            <input class="input sm" type="number" id="mv" step="1" placeholder="2700">
          </div>
          <div>
            <label class="small">Spin drift (on/off)</label>
            <select id="spin">
              <option value="off">Off</option>
              <option value="on">On</option>
            </select>
          </div>
          <div>
            <label class="small">Wind units</label>
            <select id="windUnits">
              <option value="MPH">MPH</option>
              <option value="MS">m/s</option>
            </select>
          </div>
          <button id="save" class="ghost">Save</button>
        </div>
      </div>
    </div>

    <!-- Right: Minimal “Scenario” panel (auto) -->
    <div class="panel">
      <h2>Scenario</h2>
      <p class="small">Drag inside the target: distance from center = wind speed, angle sets crosswind. Exact numbers shown in the HUD.</p>
      <div style="height:12px"></div>
      <button id="randomize" class="primary">Randomize</button>
      <button id="resetWind" class="ghost">Center Wind</button>
      <div style="height:12px"></div>
      <div class="small" id="debug" style="opacity:.7"></div>
    </div>
  </div>
</main>

<footer class="container footer">
  <div>© <span id="y"></span> Impact Ballistics.</div>
</footer>
<script>document.getElementById('y').textContent=new Date().getFullYear();</script>

<script>
/* ========= Core helpers ========= */
const $ = sel => document.querySelector(sel);
const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));
const milToMoa = m => m*3.43775;
const mphToMs = v => v*0.44704, msToMph = v => v/0.44704;

const els = {
  // HUD
  rProfile: $('#rProfile'), rRange: $('#rRange'), rWind: $('#rWind'), rAngle: $('#rAngle'), rDir: $('#rDir'), rMode: $('#rMode'), rUnits: $('#rUnits'),
  ansUnits: $('#ansUnits'), tol: $('#tol'), tolUnits: $('#tolUnits'),
  // IO
  answer: $('#answer'), result: $('#result'),
  sessGood: $('#sessGood'), sessBad: $('#sessBad'), lifeGood: $('#lifeGood'), lifeBad: $('#lifeBad'),
  // target/draw
  target: $('#target'), windline: $('#windline'),
  // drawer
  drawer: $('#drawer'), mode: $('#mode'), units: $('#units'), profile: $('#profile'), mphGun: $('#mphGun'), bc: $('#bc'), mv: $('#mv'), spin: $('#spin'), windUnits: $('#windUnits'),
  // buttons
  randomize: $('#randomize'), resetWind: $('#resetWind'), save: $('#save'), check: $('#check'), next: $('#next'), show: $('#show'),
  // debug
  debug: $('#debug')
};

const state = {
  rangeYd: 600,
  windMph: 10,
  angleDeg: 90,
  dir: 'R', // R or L (for display)
  mode: 'GE', // GE or BC
  units: 'MIL',
  profile: 'CF',
  mphGun: 6,
  bc: 0.510,
  mv: 2700,
  spinOn: false,
  windUnits: 'MPH'
};

const LS = {
  get(){ try { return JSON.parse(localStorage.getItem('whc-lite')||'{}'); } catch { return {}; } },
  set(obj){ localStorage.setItem('whc-lite', JSON.stringify(obj)); }
};

/* ========= Visual interaction: drag sets wind speed + angle ========= */
const RMAX = 130; // px radius mapped to max wind (≈ 25 mph)
const WMAX = 25;  // mph max from full radius

function pxToWind(px){
  const ratio = clamp(px/RMAX, 0, 1);
  return +(ratio*WMAX).toFixed(1);
}
function windToPx(w){
  return clamp(w/WMAX, 0, 1) * RMAX;
}

function setWindFromPoint(dx, dy){
  // vector from center
  const angleRad = Math.atan2(dy, dx);             // -π..π
  // map to 0..180 crosswind angle relative to shooter (90 full)
  let bearing = (angleRad*180/Math.PI);            // -180..180
  // We'll compute crosswind from component perpendicular to line of fire:
  // For trainer feel: angle relative to muzzle = 90 - bearing (but we only need |cross| via sin)
  // Direction label (R/L) for display:
  const dir = (bearing >= -90 && bearing <= 90) ? 'R' : 'L'; // dragging right side = R
  const radius = Math.hypot(dx,dy);
  const wind = pxToWind(radius);

  // Crosswind *angle* 0..180 with 90 full-value:
  // We only need the 0..180 magnitude for sin(); use:
  const ang = Math.abs(90 - (bearing)); // rough visual mapping
  const angleDeg = clamp(Math.round(ang), 0, 180);

  state.windMph = wind;
  state.angleDeg = angleDeg;
  state.dir = dir;
  drawWindline(bearing, radius);
  updateHUD();
}

function drawWindline(bearingDeg, radiusPx){
  const len = clamp(radiusPx, 0, RMAX) + 20;
  els.windline.style.setProperty('--deg', (bearingDeg) + 'deg');
  els.windline.style.setProperty('--len', len + 'px');
}

/* Pointer events */
function centerOf(el){
  const r = el.getBoundingClientRect();
  return { cx: r.left + r.width/2, cy: r.top + r.height/2 };
}
let dragging = false;
function pointerToTarget(e){
  const t = e.touches ? e.touches[0] : e;
  const {cx,cy} = centerOf(els.target);
  setWindFromPoint(t.clientX - cx, t.clientY - cy);
}
els.target.addEventListener('pointerdown', e => { dragging=true; els.target.setPointerCapture(e.pointerId); pointerToTarget(e); });
els.target.addEventListener('pointermove', e => { if(dragging) pointerToTarget(e); });
els.target.addEventListener('pointerup',   e => { dragging=false; });
els.target.addEventListener('touchstart', e => { pointerToTarget(e); }, {passive:false});
els.target.addEventListener('touchmove',  e => { pointerToTarget(e); }, {passive:false});

/* ========= Scenario + math ========= */
function rfAutoMphFromVelocity(mv){
  const v = Math.max(800, Math.min(1500, mv||1070));
  return clamp(1.6 + (v-900)/300 * 0.9, 1.6, 3.0);
}
function pickMphGun(){
  if (state.mode==='GE' && state.mphGun>0) return state.mphGun;
  if (state.mode==='BC' && state.bc>0) return clamp(Math.round(state.bc*10), 3, 10);
  if (state.profile==='RF') return rfAutoMphFromVelocity(state.mv||1070);
  return 5.5;
}
function computeHold(){
  const cross = Math.sin(state.angleDeg * Math.PI/180); // 0..1
  const mphGun = pickMphGun();
  const windMil = (state.rangeYd/1000) * (state.windMph / mphGun) * cross;
  const spinMil = state.spinOn ? spinDriftMil(state.rangeYd) : 0;
  const mil = windMil + spinMil;
  return state.units==='MIL' ? mil : milToMoa(mil);
}
// placeholder spin; swap with your exact if you want it included
function spinDriftMil(yards){ return 0.05 * Math.pow(Math.max(0,yards)/600, 1.7); }

function randomize(){
  // range steps like app: CF 200..1000 by 100; RF 100..400 by 25
  state.rangeYd = state.profile==='CF'
    ? [200,300,400,500,600,700,800,900,1000][Math.floor(Math.random()*9)]
    : [100,125,150,175,200,225,250,275,300,325,350,375,400][Math.floor(Math.random()*13)];
  // wind & angle randomized but you can override by dragging
  state.windMph = +(4 + Math.random()*14).toFixed(1); // 4..18 mph
  state.angleDeg = [30,45,60,75,90,105,120,135,150][Math.floor(Math.random()*9)];
  state.dir = (state.angleDeg<90) ? 'R' : 'L';
  // draw line based on current wind/angle
  const rad = windToPx(state.windMph);
  const bearingDeg = 90 - state.angleDeg; // inverse mapping from our earlier estimate
  drawWindline(bearingDeg, rad);
  updateHUD(); els.answer.value=''; els.result.textContent='—';
}

function updateHUD(){
  els.rProfile.textContent = state.profile;
  els.rRange.textContent = state.rangeYd;
  els.rWind.textContent = (state.windUnits==='MS' ? (mphToMs(state.windMph)).toFixed(1) : state.windMph.toFixed(1));
  els.rAngle.textContent = state.angleDeg;
  els.rDir.textContent = state.dir;
  els.rMode.textContent = state.mode;
  els.rUnits.textContent = state.units;
  els.ansUnits.textContent = state.units;
  els.tol.textContent = state.units==='MIL' ? '0.2' : (milToMoa(0.2)).toFixed(1);
  els.tolUnits.textContent = state.units;
  els.debug.textContent = `mphGun=${pickMphGun().toFixed(2)} | wind=${state.windMph.toFixed(1)} mph | angle=${state.angleDeg}° | range=${state.rangeYd} yd`;
}

/* ========= Scores ========= */
let sess = {good:0,bad:0};
function getLife(){ return {good:Number(els.lifeGood.textContent)||0, bad:Number(els.lifeBad.textContent)||0}; }
function setLife(v){ els.lifeGood.textContent=v.good; els.lifeBad.textContent=v.bad; }
function load(){
  const st = LS.get();
  if (st.state){
    Object.assign(state, st.state);
  }
  if (st.life) setLife(st.life);
  updateHUD();
}
function save(){ LS.set({state, life:getLife()}); }

/* ========= UI wiring ========= */
function check(show=false){
  const expected = computeHold();
  const tol = state.units==='MIL' ? 0.2 : milToMoa(0.2);
  let user = Number(els.answer.value);
  if (show || isNaN(user)) user = expected;
  const ok = Math.abs(user-expected) <= tol;

  if (!show){
    const life = getLife();
    if (ok){ sess.good++; life.good++; } else { sess.bad++; life.bad++; }
    els.sessGood.textContent = sess.good; els.sessBad.textContent = sess.bad;
    setLife(life); save();
  }
  els.result.textContent = `${expected.toFixed(1)} ${state.units} ${ok?'✓':'✗'}`;
  els.result.className = 'score ' + (ok ? 'good':'bad');
}

function next(){ randomize(); els.answer.focus(); save(); }

$('#check').addEventListener('click', ()=>check(false));
$('#show').addEventListener('click', ()=>check(true));
$('#next').addEventListener('click', next);
$('#randomize').addEventListener('click', next);
$('#resetWind').addEventListener('click', ()=>{
  // center = 0 wind
  state.windMph = 0; state.angleDeg = 90; state.dir='R';
  drawWindline(0,0); updateHUD();
});

/* Settings drawer */
let open = false;
function syncDrawerFromState(){
  els.mode.value = state.mode; els.units.value = state.units; els.profile.value = state.profile;
  els.mphGun.value = state.mphGun; els.bc.value = state.bc; els.mv.value = state.mv;
  els.spin.value = state.spinOn ? 'on':'off'; els.windUnits.value = state.windUnits;
}
function syncStateFromDrawer(){
  state.mode = els.mode.value; state.units = els.units.value; state.profile = els.profile.value;
  state.mphGun = Number(els.mphGun.value)||state.mphGun;
  state.bc = Number(els.bc.value)||state.bc; state.mv = Number(els.mv.value)||state.mv;
  state.spinOn = els.spin.value==='on';
  state.windUnits = els.windUnits.value;
  updateHUD(); save();
}
$('#save').addEventListener('click', ()=>{ syncStateFromDrawer(); });

document.addEventListener('keydown', e=>{
  if (e.key==='Enter'){ check(false); }
  if (e.key==='n' || e.key==='N'){ next(); }
  if (e.key==='s' || e.key==='S'){
    open=!open;
    if (open){ syncDrawerFromState(); els.drawer.style.display='block'; }
    else { els.drawer.style.display='none'; }
  }
  // quick nudges
  if (e.key==='ArrowUp'){ state.rangeYd += state.profile==='CF'?100:25; if(state.profile==='CF') state.rangeYd=clamp(state.rangeYd,200,1000); else state.rangeYd=clamp(state.rangeYd,100,400); updateHUD(); save(); }
  if (e.key==='ArrowDown'){ state.rangeYd -= state.profile==='CF'?100:25; if(state.profile==='CF') state.rangeYd=clamp(state.rangeYd,200,1000); else state.rangeYd=clamp(state.rangeYd,100,400); updateHUD(); save(); }
  if (e.key==='ArrowLeft'){ state.windMph = clamp(state.windMph-0.5,0,WMAX); drawWindline(0,windToPx(state.windMph)); updateHUD(); }
  if (e.key==='ArrowRight'){ state.windMph = clamp(state.windMph+0.5,0,WMAX); drawWindline(0,windToPx(state.windMph)); updateHUD(); }
});

/* Init */
(function(){
  load();
  // draw starting wind vector from state
  drawWindline(90 - state.angleDeg, windToPx(state.windMph));
  updateHUD();
  els.answer.focus();
})();
</script>
</body>
</html>
